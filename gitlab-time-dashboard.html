<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitLab Time Tracking Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load modular JavaScript files -->
    <script src="js/api-client.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/analytics.js"></script>
    <style>
      :root {
        /* Light Mode Colors (Default) */
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-gradient-start: #667eea;
        --bg-gradient-end: #764ba2;
        --text-primary: #333333;
        --text-secondary: #555555;
        --text-tertiary: #777777;
        --text-muted: #999999;
        --border-color: #e0e0e0;
        --border-light: #f0f0f0;
        --input-border: #e0e0e0;
        --input-background: #ffffff;
        --button-primary: #667eea;
        --button-hover: #5568d3;
        --button-disabled: #cccccc;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --chart-bg: #ffffff;
        --chart-text: #333333;
        --chart-grid: #e0e0e0;
        --error-bg: #fee;
        --error-text: #c33;
        --error-border: #c33;
        --success-bg: #efe;
        --success-text: #3c3;
        --warning-bg: #ffe;
        --warning-text: #cc3;
        --spinner-bg: #f3f3f3;
        --spinner-primary: #667eea;
        --focus-color: #667eea;
        --placeholder-text: #999999;
        --hover-bg: #f8f9fa;
        --modal-backdrop: rgba(0, 0, 0, 0.5);
      }

      /* Dark Mode Colors */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-primary: #1a1a1a;
          --bg-secondary: #2d2d2d;
          --bg-gradient-start: #1e3a8a;
          --bg-gradient-end: #6b21a8;
          --text-primary: #e0e0e0;
          --text-secondary: #b0b0b0;
          --text-tertiary: #909090;
          --text-muted: #707070;
          --border-color: #444444;
          --border-light: #333333;
          --input-border: #555555;
          --input-background: #2d2d2d;
          --button-primary: #667eea;
          --button-hover: #7c8ff5;
          --button-disabled: #555555;
          --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
          --chart-bg: #2d2d2d;
          --chart-text: #e0e0e0;
          --chart-grid: #444444;
          --error-bg: #3a1a1a;
          --error-text: #ff6b6b;
          --error-border: #ff6b6b;
          --success-bg: #1a3a1a;
          --success-text: #6bff6b;
          --warning-bg: #3a3a1a;
          --warning-text: #ffff6b;
          --spinner-bg: #3a3a3a;
          --spinner-primary: #667eea;
          --focus-color: #667eea;
          --placeholder-text: #707070;
          --hover-bg: #3a3a3a;
          --modal-backdrop: rgba(0, 0, 0, 0.7);
        }
      }

      /* User-controlled dark mode */
      [data-theme="dark"] {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-gradient-start: #1e3a8a;
        --bg-gradient-end: #6b21a8;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --text-tertiary: #909090;
        --text-muted: #707070;
        --border-color: #444444;
        --border-light: #333333;
        --input-border: #555555;
        --input-background: #2d2d2d;
        --button-primary: #667eea;
        --button-hover: #7c8ff5;
        --button-disabled: #555555;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        --chart-bg: #2d2d2d;
        --chart-text: #e0e0e0;
        --chart-grid: #444444;
        --error-bg: #3a1a1a;
        --error-text: #ff6b6b;
        --error-border: #ff6b6b;
        --success-bg: #1a3a1a;
        --success-text: #6bff6b;
        --warning-bg: #3a3a1a;
        --warning-text: #ffff6b;
        --spinner-bg: #3a3a3a;
        --spinner-primary: #667eea;
        --focus-color: #667eea;
        --placeholder-text: #707070;
        --hover-bg: #3a3a3a;
        --modal-backdrop: rgba(0, 0, 0, 0.7);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        min-height: 100vh;
        padding: 20px;
        color: var(--text-primary);
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: var(--bg-primary);
        padding: 30px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        margin-bottom: 20px;
      }

      h1 {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 28px;
      }

      .config-section {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 20px;
      }

      .date-filter-section {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
      }

      .input-group {
        flex: 1;
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 14px;
      }

      .help-text {
        margin-top: 6px;
        color: var(--text-muted);
        font-size: 12px;
        line-height: 1.4;
      }

      .help-tooltip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        margin-left: 6px;
        border-radius: 50%;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-size: 11px;
        cursor: help;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .checkbox-row input[type="checkbox"] {
        width: auto;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--input-border);
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
        background: var(--input-background);
        color: var(--text-primary);
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--focus-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        padding: 12px 24px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background: #5568d3;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      button:focus-visible,
      input:focus-visible,
      select:focus-visible,
      .tab-button:focus-visible,
      .modal-close:focus-visible {
        outline: 3px solid var(--focus-color);
        outline-offset: 2px;
      }

      .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 6px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
      }

      .badge.badge-starred {
        background: rgba(102, 126, 234, 0.15);
        color: var(--text-primary);
      }

      .badge.badge-archived {
        background: rgba(153, 153, 153, 0.2);
        color: var(--text-secondary);
      }

      .badge.badge-owned {
        background: rgba(67, 233, 123, 0.2);
        color: var(--text-primary);
      }

      @media (max-width: 768px) {
        .header > div:first-child {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .config-section,
        .date-filter-section {
          flex-direction: column;
          align-items: stretch;
        }

        .input-group {
          min-width: 100%;
        }

        button {
          width: 100%;
        }

        .chart-container {
          height: 280px;
        }

        table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
      }

      .loading {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #c33;
      }

      .success {
        background: #efe;
        color: #2b7a2b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #2b7a2b;
      }

      .input-error {
        border-color: var(--error-border) !important;
      }

      .input-success {
        border-color: var(--success-text) !important;
      }

      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
      }

      .toast {
        min-width: 220px;
        max-width: 360px;
        padding: 12px 14px;
        border-radius: 8px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        color: var(--text-primary);
        background: var(--bg-primary);
        border-left: 4px solid var(--border-color);
        font-size: 13px;
      }

      .toast.toast-success {
        border-left-color: var(--success-text);
      }

      .toast.toast-error {
        border-left-color: var(--error-border);
      }

      .toast.toast-warning {
        border-left-color: var(--warning-text);
      }

      .copy-id-btn {
        margin-left: auto;
        padding: 6px 10px;
        font-size: 12px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
      }

      .copy-id-btn:hover {
        background: var(--hover-bg);
      }

      .dashboard {
        display: grid;
        gap: 20px;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
      }

      .analytics-card {
        min-height: 220px;
      }

      .risk-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: var(--bg-secondary);
        color: var(--text-secondary);
      }

      .risk-badge.high {
        background: rgba(204, 51, 51, 0.15);
        color: var(--error-text);
      }

      .risk-badge.low {
        background: rgba(60, 204, 60, 0.15);
        color: var(--success-text);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: var(--bg-primary);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
      }

      .stat-label {
        color: var(--text-tertiary);
        font-size: 14px;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        color: var(--text-primary);
        font-size: 32px;
        font-weight: 700;
      }

      .card {
        background: var(--bg-primary);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
      }

      .card h2 {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 20px;
        border-bottom: 2px solid var(--button-primary);
        padding-bottom: 10px;
      }

      .chart-card {
        background: var(--bg-primary);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        height: 500px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: var(--bg-secondary);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--border-color);
      }

      td {
        padding: 12px;
        border-bottom: 1px solid var(--border-light);
      }

      tr:hover {
        background: var(--hover-bg);
      }

      .hours {
        font-weight: 600;
        color: var(--button-primary);
      }

      .progress-bar {
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 5px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        transition: width 0.3s;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      .member-row {
        cursor: pointer;
        transition: background 0.2s;
      }

      .member-row:hover {
        background: var(--hover-bg) !important;
      }

      .chart-container {
        width: 100%;
        height: 400px;
        position: relative;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: var(--modal-backdrop);
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: var(--bg-primary);
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        animation: slideUp 0.3s;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 25px;
        border-bottom: 2px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        color: var(--text-primary);
        font-size: 24px;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
      }

      .modal-close:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
      }

      .modal-body {
        padding: 25px;
        max-height: calc(80vh - 100px);
        overflow-y: auto;
      }

      .time-entry {
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
      }

      .time-entry:hover {
        border-color: var(--button-primary);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      }

      .time-entry:last-child {
        margin-bottom: 0;
      }

      .time-entry-info {
        flex: 1;
      }

      .time-entry-date {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 5px;
      }

      .time-entry-pbi {
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 500;
      }

      .time-entry-comment {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 8px;
        padding: 8px 12px;
        background: var(--bg-secondary);
        border-left: 3px solid var(--button-primary);
        border-radius: 4px;
        font-style: italic;
      }

      .time-entry.negative .time-entry-comment {
        background: var(--error-bg);
        border-left-color: var(--error-text);
        color: var(--error-text);
      }

      .time-entry-hours {
        font-weight: 700;
        color: var(--button-primary);
        font-size: 20px;
        margin-left: 20px;
      }

      .time-entry-hours.negative {
        color: var(--error-text);
      }

      .time-entry.negative {
        background: var(--error-bg);
        border-left: 3px solid var(--error-text);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .project-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .project-item {
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .project-item:hover {
        border-color: var(--button-primary);
        background: var(--hover-bg);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      }

      .project-info {
        flex: 1;
      }

      .project-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
      }

      .project-path {
        font-size: 12px;
        color: var(--text-muted);
      }

      .project-id {
        font-size: 14px;
        color: var(--button-primary);
        font-weight: 600;
      }

      .project-filters {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .filter-section h3 {
        margin-bottom: 15px;
        color: var(--text-primary);
        font-size: 16px;
      }

      .filter-checkboxes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: background 0.2s;
      }

      .checkbox-label:hover {
        background: var(--bg-primary);
      }

      .checkbox-label input[type="checkbox"] {
        width: auto;
        cursor: pointer;
      }

      .checkbox-label span {
        font-size: 14px;
        color: var(--text-secondary);
      }

      .filter-search {
        margin-bottom: 15px;
      }

      .filter-search input {
        width: 100%;
      }

      .search-button {
        width: 100%;
      }

      /* Tab Navigation Styles */
      .tab-button {
        padding: 10px 20px;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        border-bottom: 3px solid transparent;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 0;
      }

      .tab-button:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .tab-button.active {
        color: var(--button-primary);
        border-bottom-color: var(--button-primary);
        background: transparent;
      }

      .tab-button:focus {
        outline: 2px solid var(--focus-color);
        outline-offset: -2px;
      }

      .tab-content {
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h1>GitLab Time Tracking Dashboard</h1>
          <button
            id="themeToggleBtn"
            onclick="toggleDarkMode()"
            style="
              padding: 8px 12px;
              font-size: 12px;
              background: var(--bg-secondary);
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
            title="Toggle Dark Mode"
            aria-label="Toggle dark mode"
          >
            Dark
          </button>
        </div>
        <div class="config-section">
          <div class="input-group">
            <label for="gitlabUrl">GitLab URL</label>
            <input
              type="text"
              id="gitlabUrl"
              placeholder="https://gitlab.com"
              value="https://gitlab.com"
            />
            <div class="help-text">Base URL for your GitLab instance.</div>
          </div>
          <div class="input-group">
            <label for="accessToken"
              >Access Token<span
                class="help-tooltip"
                title="Use a personal access token with read_api scope."
                >?</span
              ></label
            >
            <input
              type="password"
              id="accessToken"
              placeholder="Your GitLab access token"
            />
            <div class="help-text">Stored only in memory for this session.</div>
          </div>
          <div class="input-group">
            <label for="projectId"
              >Project ID<span
                class="help-tooltip"
                title="Find this in Project Settings â†’ General or the project URL."
                >?</span
              ></label
            >
            <input type="text" id="projectId" placeholder="12345" />
            <div class="help-text">Numeric ID of the project to load.</div>
          </div>
          <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="showProjectBrowser()" aria-label="Browse projects">
              Browse Projects
            </button>
          </div>
          <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="fetchData()" aria-label="Load data">
              Load Data
            </button>
          </div>
          <div class="input-group">
            <label for="rememberSettings">Remember Settings</label>
            <div class="checkbox-row">
              <input type="checkbox" id="rememberSettings" checked />
              <span class="help-text"
                >Save GitLab URL and Project ID in this browser.</span
              >
            </div>
          </div>
        </div>

        <div class="help-text">
          Shortcuts: <strong>/</strong> focus project search,
          <strong>L</strong> load data, <strong>Esc</strong> close dialogs.
        </div>

        <div class="date-filter-section">
          <div class="input-group">
            <label for="filterType">Filter By</label>
            <select id="filterType" onchange="toggleFilterType()">
              <option value="date">Date Range</option>
              <option value="milestone">Milestone</option>
            </select>
          </div>
          <div id="dateRangeInputs" style="display: flex; gap: 15px; flex: 1">
            <div class="input-group">
              <label for="startDate">Start Date</label>
              <input type="date" id="startDate" />
            </div>
            <div class="input-group">
              <label for="endDate">End Date</label>
              <input type="date" id="endDate" />
            </div>
          </div>
          <div id="milestoneInput" style="display: none; flex: 1">
            <div class="input-group">
              <label for="milestoneSelect">Milestone</label>
              <select id="milestoneSelect">
                <option value="">Select a milestone...</option>
              </select>
            </div>
          </div>
          <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="applyFilter()" aria-label="Apply filter">
              Apply Filter
            </button>
          </div>
        </div>
      </div>

      <div
        id="error"
        style="display: none"
        class="error"
        role="alert"
        aria-live="polite"
      ></div>
      <div
        id="loading"
        style="display: none"
        class="loading"
        role="status"
        aria-live="polite"
      >
        <div class="spinner"></div>
        <p id="loadingMessage">Fetching data from GitLab...</p>
      </div>

      <div id="dashboard" style="display: none" class="dashboard">
        <!-- Tab Navigation -->
        <div
          style="
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
          "
          role="tablist"
          aria-label="Dashboard tabs"
        >
          <button
            class="tab-button active"
            data-tab="overview"
            onclick="switchTab('overview')"
            role="tab"
            aria-selected="true"
            aria-controls="tab-overview"
          >
            Overview
          </button>
          <button
            class="tab-button"
            data-tab="analytics"
            onclick="switchTab('analytics')"
            role="tab"
            aria-selected="false"
            aria-controls="tab-analytics"
          >
            Analytics
          </button>
          <button
            class="tab-button"
            data-tab="details"
            onclick="switchTab('details')"
            role="tab"
            aria-selected="false"
            aria-controls="tab-details"
          >
            Details
          </button>
        </div>

        <!-- Filter Status Bar -->
        <div
          id="filterStatus"
          style="
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            display: none;
          "
        ></div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content" style="display: block">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Hours Logged</div>
              <div class="stat-value" id="totalHours">0h</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Active PBIs</div>
              <div class="stat-value" id="totalPbis">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Team Members</div>
              <div class="stat-value" id="totalMembers">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Hours per Person</div>
              <div class="stat-value" id="avgHours">0h</div>
            </div>
          </div>

          <div class="chart-card">
            <h2>Cumulative Hours by Team Member</h2>
            <div class="chart-container">
              <canvas id="cumulativeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div id="tab-analytics" class="tab-content" style="display: none">
          <div class="analytics-grid">
            <div class="card analytics-card">
              <h2>Workload Distribution</h2>
              <div class="chart-container" style="height: 260px">
                <canvas id="workloadChart"></canvas>
              </div>
            </div>

            <div class="card analytics-card">
              <h2>WIP Stalled Issues</h2>
              <table>
                <thead>
                  <tr>
                    <th>Issue</th>
                    <th>Last Entry</th>
                    <th>Days Since</th>
                  </tr>
                </thead>
                <tbody id="stalledTableBody"></tbody>
              </table>
              <div id="stalledEmpty" class="no-data" style="display: none">
                No stalled issues detected.
              </div>
            </div>

            <div class="card analytics-card">
              <h2>Rework Analysis</h2>
              <table>
                <thead>
                  <tr>
                    <th>Issue</th>
                    <th>Negative Hours</th>
                    <th>Rework %</th>
                  </tr>
                </thead>
                <tbody id="reworkTableBody"></tbody>
              </table>
              <div id="reworkEmpty" class="no-data" style="display: none">
                No rework detected.
              </div>
            </div>

            <div class="card analytics-card">
              <h2>Anomalies</h2>
              <div id="anomaliesSummary" class="help-text">
                No anomalies detected.
              </div>
              <div id="anomaliesList"></div>
            </div>

            <div class="card analytics-card">
              <h2>Burnout Risk</h2>
              <table>
                <thead>
                  <tr>
                    <th>Member</th>
                    <th>Rolling Avg (4w)</th>
                    <th>Risk</th>
                  </tr>
                </thead>
                <tbody id="burnoutTableBody"></tbody>
              </table>
              <div id="burnoutEmpty" class="no-data" style="display: none">
                No burnout risk detected.
              </div>
            </div>

            <div class="card analytics-card">
              <h2>Estimation Accuracy</h2>
              <div class="chart-container" style="height: 260px">
                <canvas id="estimationChart"></canvas>
              </div>
              <div id="estimationSummary" class="help-text"></div>
            </div>
          </div>
        </div>

        <!-- Details Tab -->
        <div id="tab-details" class="tab-content" style="display: block">
          <div class="card">
            <h2>Hours by PBI</h2>
            <table id="pbiTable">
              <thead>
                <tr>
                  <th>PBI #</th>
                  <th>Title</th>
                  <th>Assignee</th>
                  <th>Hours Logged</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody id="pbiTableBody"></tbody>
            </table>
            <div id="noPbiData" class="no-data" style="display: none">
              No PBI data available. Make sure issues have time tracking
              entries.
            </div>
          </div>

          <div class="card">
            <h2>
              Hours by Team Member
              <small style="color: var(--text-muted); font-size: 14px"
                >(Click to view details)</small
              >
            </h2>
            <table id="memberTable">
              <thead>
                <tr>
                  <th>Team Member</th>
                  <th>PBIs Worked On</th>
                  <th>Total Hours</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody id="memberTableBody"></tbody>
            </table>
            <div id="noMemberData" class="no-data" style="display: none">
              No team member data available.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for time entries -->
    <div
      id="timeEntriesModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
      aria-hidden="true"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Time Entries</h2>
          <button
            class="modal-close"
            onclick="closeModal()"
            aria-label="Close time entries dialog"
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Time entries will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Modal for project browser -->
    <div
      id="projectBrowserModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="projectBrowserTitle"
      aria-hidden="true"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="projectBrowserTitle">Select Project</h2>
          <button
            class="modal-close"
            onclick="closeProjectBrowser()"
            aria-label="Close project browser"
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="projectBrowserBody">
          <div class="project-filters">
            <div class="filter-section">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 15px;
                "
              >
                <h3 style="margin: 0">Filter Options</h3>
                <div style="display: flex; gap: 10px">
                  <button
                    onclick="selectAllFilters()"
                    style="
                      padding: 6px 12px;
                      font-size: 12px;
                      background: #667eea;
                    "
                  >
                    Select All
                  </button>
                  <button
                    onclick="clearAllFilters()"
                    style="padding: 6px 12px; font-size: 12px; background: #999"
                  >
                    Clear All
                  </button>
                </div>
              </div>
              <div class="filter-checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" id="filterStarred" checked />
                  <span>Starred</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filterMember" checked />
                  <span>My Projects</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filterOwned" />
                  <span>Owned by Me</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filterInactive" />
                  <span>Archived</span>
                </label>
              </div>
            </div>
            <div class="filter-search">
              <input
                type="text"
                id="projectSearch"
                placeholder="Search by name or path..."
                onkeypress="if (event.key === 'Enter') searchProjects();"
              />
            </div>
            <button
              onclick="searchProjects()"
              class="search-button"
              aria-label="Search projects"
            >
              Search Projects
            </button>
          </div>
          <div class="loading" id="projectsLoading" style="display: none">
            <div class="spinner"></div>
            <p>Loading projects...</p>
          </div>
          <div
            id="projectsResultCount"
            style="margin-bottom: 10px; color: #666; font-size: 14px"
          ></div>
          <div id="projectsList" class="project-list"></div>
        </div>
      </div>
    </div>

    <div
      id="toastContainer"
      class="toast-container"
      aria-live="polite"
      aria-atomic="true"
    ></div>

    <script>
      // ========== SETTINGS MANAGER CLASS ==========
      class SettingsManager {
        static STORAGE_KEY = "gitlab-dashboard-settings";
        static REMEMBER_KEY = "gitlab-dashboard-remember";

        static saveSettings(url, projectId) {
          try {
            const settings = { url, projectId, timestamp: Date.now() };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(settings));
            return true;
          } catch (error) {
            console.warn("Failed to save settings:", error);
            return false;
          }
        }

        static loadSettings() {
          try {
            const json = localStorage.getItem(this.STORAGE_KEY);
            return json ? JSON.parse(json) : {};
          } catch (error) {
            console.warn("Failed to load settings:", error);
            return {};
          }
        }

        static clearSettings() {
          try {
            localStorage.removeItem(this.STORAGE_KEY);
            return true;
          } catch (error) {
            console.warn("Failed to clear settings:", error);
            return false;
          }
        }

        static saveRememberPreference(enabled) {
          try {
            localStorage.setItem(this.REMEMBER_KEY, JSON.stringify(!!enabled));
            return true;
          } catch (error) {
            console.warn("Failed to save remember preference:", error);
            return false;
          }
        }

        static loadRememberPreference() {
          try {
            const stored = localStorage.getItem(this.REMEMBER_KEY);
            return stored ? JSON.parse(stored) : true;
          } catch (error) {
            console.warn("Failed to load remember preference:", error);
            return true;
          }
        }
      }

      // ========== GLOBAL STATE ==========
      let allData = {
        issues: [],
        rawTimeEntries: [],
        filteredTimeEntries: [],
        cumulativeChart: null,
        milestones: [],
        analytics: null,
        analyticsCharts: {
          workload: null,
          estimation: null,
        },
      };

      let dateFilter = {
        start: null,
        end: null,
        type: "date", // 'date' or 'milestone'
        milestoneId: null,
      };

      // Initialize date filters to last month
      function initializeDateFilters() {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 1);

        document.getElementById("startDate").valueAsDate = startDate;
        document.getElementById("endDate").valueAsDate = endDate;

        dateFilter.start = startDate.toISOString().split("T")[0];
        dateFilter.end = endDate.toISOString().split("T")[0];
      }

      // Load configuration from .env file
      async function loadEnvConfig() {
        try {
          const response = await fetch(".env");
          if (response.ok) {
            const envText = await response.text();
            const envVars = {};

            // Parse .env file
            envText.split("\n").forEach((line) => {
              line = line.trim();
              // Skip comments and empty lines
              if (line && !line.startsWith("#")) {
                const [key, ...valueParts] = line.split("=");
                if (key && valueParts.length > 0) {
                  const value = valueParts.join("=").trim();
                  envVars[key.trim()] = value;
                }
              }
            });

            // Apply values to form fields
            if (envVars.TARGET_LINK) {
              document.getElementById("gitlabUrl").value = envVars.TARGET_LINK;
            }
            if (envVars.TARGET_API_KEY) {
              document.getElementById("accessToken").value =
                envVars.TARGET_API_KEY;
            }
            if (envVars.TARGET_PROJECT_ID) {
              document.getElementById("projectId").value =
                envVars.TARGET_PROJECT_ID;
            }
          }
        } catch (error) {
          // Silently fail if .env file is not found or can't be loaded
          console.log("No .env file found or could not be loaded");
        }
      }

      function toggleFilterType() {
        const filterType = document.getElementById("filterType").value;
        const dateRangeInputs = document.getElementById("dateRangeInputs");
        const milestoneInput = document.getElementById("milestoneInput");

        if (filterType === "date") {
          dateRangeInputs.style.display = "flex";
          milestoneInput.style.display = "none";
        } else {
          dateRangeInputs.style.display = "none";
          milestoneInput.style.display = "block";
        }
      }

      async function loadMilestones() {
        const gitlabUrl = document.getElementById("gitlabUrl").value.trim();
        const accessToken = document.getElementById("accessToken").value.trim();
        const projectId = document.getElementById("projectId").value.trim();

        if (!gitlabUrl || !accessToken || !projectId) {
          return;
        }

        try {
          const response = await apiClient.fetch(
            `${gitlabUrl}/api/v4/projects/${projectId}/milestones?per_page=100`,
            {
              headers: {
                "PRIVATE-TOKEN": accessToken,
              },
            },
          );

          if (response.ok) {
            allData.milestones = await response.json();
            const milestoneSelect = document.getElementById("milestoneSelect");
            milestoneSelect.innerHTML =
              '<option value="">Select a milestone...</option>';

            allData.milestones.forEach((milestone) => {
              const option = document.createElement("option");
              option.value = milestone.id;
              option.textContent = milestone.title;
              milestoneSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.warn("Failed to load milestones:", error);
        }
      }

      function applyFilter() {
        const filterType = document.getElementById("filterType").value;

        if (filterType === "date") {
          applyDateFilter();
        } else {
          applyMilestoneFilter();
        }
      }

      function applyMilestoneFilter() {
        const milestoneId = document.getElementById("milestoneSelect").value;

        if (!milestoneId) {
          showError("Please select a milestone");
          return;
        }

        const milestone = allData.milestones.find((m) => m.id == milestoneId);
        if (!milestone) {
          showError("Milestone not found");
          return;
        }

        dateFilter.type = "milestone";
        dateFilter.milestoneId = milestoneId;
        dateFilter.start = milestone.start_date || null;
        dateFilter.end = milestone.due_date || null;

        // Filter time entries by milestone dates
        if (dateFilter.start && dateFilter.end) {
          allData.filteredTimeEntries = allData.rawTimeEntries.filter(
            (entry) => {
              return (
                entry.date >= dateFilter.start && entry.date <= dateFilter.end
              );
            },
          );
        } else {
          // If milestone has no dates, show all entries
          allData.filteredTimeEntries = allData.rawTimeEntries;
        }

        updateAnalytics();
        renderDashboard();
      }

      async function showProjectBrowser() {
        const gitlabUrl = document.getElementById("gitlabUrl").value.trim();
        const accessToken = document.getElementById("accessToken").value.trim();

        if (!gitlabUrl || !accessToken) {
          showError("Please enter GitLab URL and Access Token first");
          return;
        }

        const modal = document.getElementById("projectBrowserModal");
        modal.classList.add("active");
        modal.setAttribute("aria-hidden", "false");
        // Auto-search on open
        searchProjects();
      }

      async function searchProjects() {
        const gitlabUrl = document.getElementById("gitlabUrl").value.trim();
        const accessToken = document.getElementById("accessToken").value.trim();

        document.getElementById("projectsLoading").style.display = "block";
        document.getElementById("projectsList").innerHTML = "";

        // Get filter options
        const filterStarred = document.getElementById("filterStarred").checked;
        const filterMember = document.getElementById("filterMember").checked;
        const filterOwned = document.getElementById("filterOwned").checked;
        const filterInactive =
          document.getElementById("filterInactive").checked;
        const searchText = document
          .getElementById("projectSearch")
          .value.trim()
          .toLowerCase();

        // Check if at least one filter is selected
        if (
          !filterStarred &&
          !filterMember &&
          !filterOwned &&
          !filterInactive
        ) {
          document.getElementById("projectsLoading").style.display = "none";
          document.getElementById("projectsList").innerHTML =
            '<div class="empty-state"><p>Please select at least one filter option</p></div>';
          document.getElementById("projectsResultCount").textContent = "";
          return;
        }

        try {
          let allProjects = [];

          // Fetch starred projects
          if (filterStarred) {
            const starredProjects = await fetchAllPages(
              `${gitlabUrl}/api/v4/projects?starred=true&per_page=100`,
              accessToken,
            );
            allProjects = allProjects.concat(
              starredProjects.map((p) => ({ ...p, source: "starred" })),
            );
          }

          // Fetch projects user is a member of
          if (filterMember) {
            const memberProjects = await fetchAllPages(
              `${gitlabUrl}/api/v4/projects?membership=true&per_page=100&order_by=last_activity_at`,
              accessToken,
            );
            allProjects = allProjects.concat(
              memberProjects.map((p) => ({ ...p, source: "member" })),
            );
          }

          // Fetch projects owned by user
          if (filterOwned) {
            const ownedProjects = await fetchAllPages(
              `${gitlabUrl}/api/v4/projects?owned=true&per_page=100`,
              accessToken,
            );
            allProjects = allProjects.concat(
              ownedProjects.map((p) => ({ ...p, source: "owned" })),
            );
          }

          // Fetch archived projects
          if (filterInactive) {
            const archivedProjects = await fetchAllPages(
              `${gitlabUrl}/api/v4/projects?archived=true&per_page=100`,
              accessToken,
            );
            allProjects = allProjects.concat(
              archivedProjects.map((p) => ({ ...p, source: "archived" })),
            );
          }

          // Remove duplicates by project ID (keep first occurrence)
          const uniqueProjects = [];
          const seenIds = new Set();
          allProjects.forEach((project) => {
            if (!seenIds.has(project.id)) {
              seenIds.add(project.id);
              uniqueProjects.push(project);
            }
          });

          // Filter by search text
          let filteredProjects = uniqueProjects;
          if (searchText) {
            filteredProjects = uniqueProjects.filter(
              (project) =>
                project.name.toLowerCase().includes(searchText) ||
                project.path_with_namespace.toLowerCase().includes(searchText),
            );
          }

          // Sort by last activity
          filteredProjects.sort(
            (a, b) =>
              new Date(b.last_activity_at) - new Date(a.last_activity_at),
          );

          document.getElementById("projectsLoading").style.display = "none";

          // Display result count
          document.getElementById("projectsResultCount").textContent =
            `Found ${filteredProjects.length} project${filteredProjects.length === 1 ? "" : "s"}`;

          const projectsList = document.getElementById("projectsList");
          if (filteredProjects.length === 0) {
            projectsList.innerHTML =
              '<div class="empty-state"><p>No projects found</p></div>';
          } else {
            projectsList.innerHTML = filteredProjects
              .map((project) => {
                const escapedName = project.name
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;");
                const escapedPath = project.path_with_namespace
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;");

                // Add badges
                let badges = "";
                if (project.star_count > 0)
                  badges += '<span class="badge badge-starred">Starred</span>';
                if (project.archived)
                  badges +=
                    '<span class="badge badge-archived">Archived</span>';

                // Check if current user owns the project
                if (
                  project.owner &&
                  project.permissions &&
                  project.permissions.project_access
                ) {
                  const accessLevel =
                    project.permissions.project_access.access_level;
                  if (accessLevel >= 50)
                    badges += '<span class="badge badge-owned">Owner</span>';
                }

                return `
                            <div class="project-item" onclick="selectProject(${project.id}, '${escapedName.replace(/'/g, "\\'")}')" onkeydown="if(event.key==='Enter') selectProject(${project.id}, '${escapedName.replace(/'/g, "\\'")}')" role="button" tabindex="0" aria-label="Select project ${escapedName}">
                                <div class="project-info">
                                    <div class="project-name">${badges}${escapedName}</div>
                                    <div class="project-path">${escapedPath}</div>
                                </div>
                                <div class="project-id">#${project.id}</div>
                                <button type="button" class="copy-id-btn" onclick="copyProjectId(${project.id}, event)" aria-label="Copy project ID ${project.id}">Copy ID</button>
                            </div>
                        `;
              })
              .join("");
          }
        } catch (error) {
          document.getElementById("projectsLoading").style.display = "none";
          showError(error.message);
        }
      }

      async function fetchAllPages(url, accessToken) {
        let allItems = [];
        let page = 1;
        let hasMore = true;

        while (hasMore && page <= 10) {
          // Limit to 10 pages per type
          const response = await apiClient.fetch(`${url}&page=${page}`, {
            headers: {
              "PRIVATE-TOKEN": accessToken,
            },
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
          }

          const items = await response.json();
          if (items.length === 0) {
            hasMore = false;
          } else {
            allItems = allItems.concat(items);
            page++;
          }
        }

        return allItems;
      }

      function selectProject(projectId, projectName) {
        document.getElementById("projectId").value = projectId;
        closeProjectBrowser();
        showSuccess(`Selected project: ${projectName}`);
      }

      async function copyProjectId(projectId, event) {
        if (event) {
          event.stopPropagation();
          event.preventDefault();
        }
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(String(projectId));
          } else {
            const tempInput = document.createElement("input");
            tempInput.value = String(projectId);
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
          }
          showToast(`Copied project ID ${projectId}`, "success");
        } catch (error) {
          showToast("Failed to copy project ID", "error");
        }
      }

      function closeProjectBrowser() {
        const modal = document.getElementById("projectBrowserModal");
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden", "true");
      }

      function selectAllFilters() {
        document.getElementById("filterStarred").checked = true;
        document.getElementById("filterMember").checked = true;
        document.getElementById("filterOwned").checked = true;
        document.getElementById("filterInactive").checked = true;
      }

      function clearAllFilters() {
        document.getElementById("filterStarred").checked = false;
        document.getElementById("filterMember").checked = false;
        document.getElementById("filterOwned").checked = false;
        document.getElementById("filterInactive").checked = false;
      }

      // Call on page load
      initializeDateFilters();
      loadEnvConfig();

      function isRememberSettingsEnabled() {
        const rememberCheckbox = document.getElementById("rememberSettings");
        return rememberCheckbox ? rememberCheckbox.checked : true;
      }

      function initializeRememberSettings() {
        const rememberCheckbox = document.getElementById("rememberSettings");
        if (!rememberCheckbox) return;

        rememberCheckbox.checked = SettingsManager.loadRememberPreference();
        rememberCheckbox.addEventListener("change", () => {
          const enabled = rememberCheckbox.checked;
          SettingsManager.saveRememberPreference(enabled);
          if (!enabled) {
            SettingsManager.clearSettings();
          }
        });
      }

      // Load settings from localStorage
      function loadStoredSettings() {
        if (!isRememberSettingsEnabled()) {
          return;
        }
        const settings = SettingsManager.loadSettings();
        if (settings.url) {
          document.getElementById("gitlabUrl").value = settings.url;
        }
        if (settings.projectId) {
          document.getElementById("projectId").value = settings.projectId;
        }
      }

      initializeRememberSettings();
      loadStoredSettings();

      function isTypingInInput(target) {
        return (
          target && ["INPUT", "TEXTAREA", "SELECT"].includes(target.tagName)
        );
      }

      function setupEnterKeySupport() {
        const enterMap = {
          gitlabUrl: fetchData,
          accessToken: fetchData,
          projectId: fetchData,
          startDate: applyFilter,
          endDate: applyFilter,
          projectSearch: searchProjects,
        };

        Object.keys(enterMap).forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              enterMap[id]();
            }
          });
        });
      }

      function setupKeyboardShortcuts() {
        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            closeModal();
            closeProjectBrowser();
            return;
          }

          if (isTypingInInput(event.target)) {
            return;
          }

          if (event.key === "/") {
            event.preventDefault();
            const modal = document.getElementById("projectBrowserModal");
            const isOpen = modal && modal.classList.contains("active");
            if (!isOpen) {
              showProjectBrowser();
            }
            setTimeout(() => {
              const searchInput = document.getElementById("projectSearch");
              if (searchInput) searchInput.focus();
            }, 150);
          }

          if (
            event.key.toLowerCase() === "l" &&
            !event.ctrlKey &&
            !event.metaKey &&
            !event.altKey
          ) {
            event.preventDefault();
            fetchData();
          }
        });
      }

      function setValidationState(input, state) {
        if (!input) return;
        input.classList.remove("input-error", "input-success");
        if (state === "error") input.classList.add("input-error");
        if (state === "success") input.classList.add("input-success");
      }

      function validateGitlabUrl() {
        const input = document.getElementById("gitlabUrl");
        if (!input) return true;
        const value = input.value.trim();
        if (!value) {
          setValidationState(input, null);
          return false;
        }

        try {
          const url = new URL(value);
          if (url.protocol !== "http:" && url.protocol !== "https:") {
            setValidationState(input, "error");
            return false;
          }
          setValidationState(input, "success");
          return true;
        } catch (error) {
          setValidationState(input, "error");
          return false;
        }
      }

      const gitlabUrlInput = document.getElementById("gitlabUrl");
      if (gitlabUrlInput) {
        gitlabUrlInput.addEventListener("blur", () => {
          if (!validateGitlabUrl()) {
            showToast("Enter a valid GitLab URL (https://...)", "warning");
          }
        });
      }

      setupEnterKeySupport();
      setupKeyboardShortcuts();

      // Restore tab state from URL on page load
      window.addEventListener("load", () => {
        restoreTabState();
      });

      // Listen for hash changes
      window.addEventListener("hashchange", () => {
        restoreTabState();
      });

      function showToast(message, type = "info", timeout = 3500) {
        const container = document.getElementById("toastContainer");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, timeout);
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.classList.remove("success");
        errorDiv.classList.add("error");
        errorDiv.style.display = "block";
        showToast(message, "error");
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      function showSuccess(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.classList.remove("error");
        errorDiv.classList.add("success");
        errorDiv.style.display = "block";
        showToast(message, "success");
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 3000);
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
        document.getElementById("dashboard").style.display = show
          ? "none"
          : "block";
      }

      async function fetchData() {
        const gitlabUrl = document.getElementById("gitlabUrl").value.trim();
        const accessToken = document.getElementById("accessToken").value.trim();
        const projectId = document.getElementById("projectId").value.trim();

        if (!gitlabUrl || !accessToken || !projectId) {
          const missing = [];
          if (!gitlabUrl) missing.push("GitLab URL");
          if (!accessToken) missing.push("Access Token");
          if (!projectId) missing.push("Project ID");
          showError(`Missing required fields: ${missing.join(", ")}`);
          return;
        }

        // Save settings to localStorage if enabled
        if (isRememberSettingsEnabled()) {
          SettingsManager.saveSettings(gitlabUrl, projectId);
        }

        showLoading(true);
        document.getElementById("error").style.display = "none";
        document.getElementById("loadingMessage").textContent =
          "Fetching issues from GitLab...";

        try {
          // Use the DataManager to fetch all data with proper concurrency control
          const dataManager = new DataManager(apiClient);

          const data = await dataManager.fetchAllData(
            gitlabUrl,
            projectId,
            accessToken,
            (message) => {
              document.getElementById("loadingMessage").textContent = message;
            },
          );

          allData.issues = data.issues;
          allData.rawTimeEntries = data.rawTimeEntries;

          console.log(
            `Successfully loaded ${allData.rawTimeEntries.length} time entries from ${allData.issues.length} issues`,
          );

          // Load milestones in the background
          loadMilestones();

          applyDateFilter();
          showLoading(false);
        } catch (error) {
          console.error("Error fetching data:", error);
          showError(`Failed to load data: ${error.message}`);
          showLoading(false);
        }
      }

      function updateAnalytics() {
        if (typeof AnalyticsCalculator === "undefined") return;
        allData.analytics = AnalyticsCalculator.computeAll(
          allData.issues,
          allData.filteredTimeEntries,
        );
        console.log("Analytics computed", allData.analytics);
      }

      function applyDateFilter() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        dateFilter.type = "date";
        dateFilter.start = startDate;
        dateFilter.end = endDate;

        // Filter time entries by date range
        allData.filteredTimeEntries = allData.rawTimeEntries.filter((entry) => {
          return entry.date >= startDate && entry.date <= endDate;
        });

        updateAnalytics();
        renderDashboard();
      }

      function switchTab(tabName) {
        // Hide all tabs
        const tabs = document.querySelectorAll(".tab-content");
        tabs.forEach((tab) => (tab.style.display = "none"));

        // Remove active class from all buttons
        const buttons = document.querySelectorAll(".tab-button");
        buttons.forEach((btn) => {
          btn.classList.remove("active");
          btn.setAttribute("aria-selected", "false");
        });

        // Show selected tab
        const selectedTab = document.getElementById(`tab-${tabName}`);
        if (selectedTab) {
          selectedTab.style.display = "block";
        }

        // Add active class to clicked button
        const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeButton) {
          activeButton.classList.add("active");
          activeButton.setAttribute("aria-selected", "true");
        }

        // Update URL hash for shareability
        window.location.hash = `tab=${tabName}`;

        // Trigger chart resize if switching to overview tab (for responsive charts)
        if (tabName === "overview" && allData.cumulativeChart) {
          setTimeout(() => {
            allData.cumulativeChart.resize();
          }, 100);
        }
      }

      function restoreTabState() {
        const hash = window.location.hash;
        const tabMatch = hash.match(/tab=([a-z]+)/);
        const tabName = tabMatch ? tabMatch[1] : "overview";

        // Validate tab exists
        if (document.getElementById(`tab-${tabName}`)) {
          switchTab(tabName);
        }
      }

      function updateFilterStatusBar() {
        const statusBar = document.getElementById("filterStatus");
        const filterType = document.getElementById("filterType").value;

        if (filterType === "date") {
          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;
          statusBar.textContent = `Viewing: ${startDate} â†’ ${endDate}`;
        } else {
          const milestoneSelect = document.getElementById("milestoneSelect");
          const selectedMilestone =
            milestoneSelect.options[milestoneSelect.selectedIndex].text;
          statusBar.textContent = `Milestone: ${selectedMilestone}`;
        }
        statusBar.style.display =
          allData.filteredTimeEntries.length > 0 ? "block" : "none";
      }

      function renderDashboard() {
        const timeEntries = allData.filteredTimeEntries;

        // Calculate member stats
        const memberStats = {};
        timeEntries.forEach((entry) => {
          if (!memberStats[entry.username]) {
            memberStats[entry.username] = {
              name: entry.author,
              username: entry.username,
              hours: 0,
              pbiCount: new Set(),
            };
          }
          memberStats[entry.username].hours += entry.hours;
          memberStats[entry.username].pbiCount.add(entry.issueId);
        });

        Object.values(memberStats).forEach((member) => {
          member.pbiCount = member.pbiCount.size;
        });

        const memberArray = Object.values(memberStats);
        const maxMemberHours = Math.max(...memberArray.map((m) => m.hours), 0);
        const totalHours = memberArray.reduce((sum, m) => sum + m.hours, 0);

        // Count unique PBIs in filtered data
        const uniquePbis = new Set(timeEntries.map((e) => e.issueId));

        // Update stats
        document.getElementById("totalHours").textContent =
          totalHours.toFixed(1) + "h";
        document.getElementById("totalPbis").textContent = uniquePbis.size;
        document.getElementById("totalMembers").textContent =
          memberArray.length;
        document.getElementById("avgHours").textContent =
          memberArray.length > 0
            ? (totalHours / memberArray.length).toFixed(1) + "h"
            : "0h";

        // Render cumulative chart
        renderCumulativeChart(timeEntries, memberStats);

        // Render PBI table (filtered)
        renderPbiTable(timeEntries);

        // Render member table
        renderMemberTable(memberArray, maxMemberHours);

        // Update filter status bar
        updateFilterStatusBar();
        renderAnalytics();

        document.getElementById("dashboard").style.display = "block";
      }

      function renderAnalytics() {
        if (!allData.analytics) return;

        renderWorkloadChart(allData.analytics.workload);
        renderStalledIssues(allData.analytics.stalled);
        renderReworkAnalysis(allData.analytics.rework);
        renderAnomalies(allData.analytics.anomalies);
        renderBurnoutRisk(allData.analytics.burnout);
        renderEstimationAccuracy(allData.analytics.estimation);
      }

      function renderWorkloadChart(workload) {
        const canvas = document.getElementById("workloadChart");
        if (!canvas) return;

        const labels = workload.map((m) => m.name || m.username);
        const data = workload.map((m) => Number(m.hours.toFixed(2)));

        if (allData.analyticsCharts.workload) {
          allData.analyticsCharts.workload.destroy();
        }

        const colors = getChartColors();
        allData.analyticsCharts.workload = new Chart(canvas, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Hours",
                data,
                backgroundColor: colors.fill,
                borderColor: colors.line,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            plugins: { legend: { display: false } },
            scales: {
              x: {
                ticks: { color: colors.text },
                grid: { color: colors.grid },
              },
              y: { ticks: { color: colors.text }, grid: { display: false } },
            },
          },
        });
      }

      function renderStalledIssues(stalled) {
        const body = document.getElementById("stalledTableBody");
        const empty = document.getElementById("stalledEmpty");
        if (!body || !empty) return;

        if (!stalled.length) {
          body.innerHTML = "";
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        body.innerHTML = stalled
          .sort((a, b) => b.daysSince - a.daysSince)
          .slice(0, 10)
          .map(
            (item) => `
                    <tr>
                        <td>#${item.issueId} ${item.title}</td>
                        <td>${item.lastEntryDate}</td>
                        <td>${item.daysSince}d</td>
                    </tr>
                `,
          )
          .join("");
      }

      function renderReworkAnalysis(rework) {
        const body = document.getElementById("reworkTableBody");
        const empty = document.getElementById("reworkEmpty");
        if (!body || !empty) return;

        if (!rework.length) {
          body.innerHTML = "";
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        body.innerHTML = rework
          .sort((a, b) => b.negativeHours - a.negativeHours)
          .slice(0, 10)
          .map(
            (item) => `
                    <tr>
                        <td>#${item.issueId} ${item.issueTitle}</td>
                        <td>${item.negativeHours.toFixed(1)}h</td>
                        <td>${item.reworkPercent.toFixed(1)}%</td>
                    </tr>
                `,
          )
          .join("");
      }

      function renderAnomalies(anomalies) {
        const summary = document.getElementById("anomaliesSummary");
        const list = document.getElementById("anomaliesList");
        if (!summary || !list) return;

        if (!anomalies.length) {
          summary.textContent = "No anomalies detected.";
          list.innerHTML = "";
          return;
        }

        summary.textContent = `Found ${anomalies.length} anomalous entries.`;
        list.innerHTML = anomalies
          .slice(0, 8)
          .map(
            (entry) => `
                <div class="help-text">#${entry.issueId} ${entry.issueTitle} â€¢ ${entry.hours.toFixed(2)}h â€¢ ${entry.reasons.join(", ")}</div>
            `,
          )
          .join("");
      }

      function renderBurnoutRisk(burnout) {
        const body = document.getElementById("burnoutTableBody");
        const empty = document.getElementById("burnoutEmpty");
        if (!body || !empty) return;

        if (!burnout.length) {
          body.innerHTML = "";
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";
        body.innerHTML = burnout
          .sort((a, b) => b.rollingAvg - a.rollingAvg)
          .map((item) => {
            const badgeClass = item.risk ? "high" : "low";
            const badgeText = item.risk ? "High" : "Low";
            return `
                        <tr>
                            <td>${item.username}</td>
                            <td>${item.rollingAvg.toFixed(1)}h</td>
                            <td><span class="risk-badge ${badgeClass}">${badgeText}</span></td>
                        </tr>
                    `;
          })
          .join("");
      }

      function renderEstimationAccuracy(estimation) {
        const summary = document.getElementById("estimationSummary");
        const canvas = document.getElementById("estimationChart");
        if (!summary || !canvas) return;

        summary.textContent = `Under: ${estimation.summary.under}, Accurate: ${estimation.summary.accurate}, Over: ${estimation.summary.over}`;

        if (allData.analyticsCharts.estimation) {
          allData.analyticsCharts.estimation.destroy();
        }

        const colors = getChartColors();
        const dataset = estimation.results.map((item) => ({
          x: item.estimateHours,
          y: item.actualHours,
        }));

        allData.analyticsCharts.estimation = new Chart(canvas, {
          type: "scatter",
          data: {
            datasets: [
              {
                label: "Estimate vs Actual",
                data: dataset,
                backgroundColor: colors.fill,
                borderColor: colors.line,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Estimate (h)",
                  color: colors.text,
                },
                ticks: { color: colors.text },
                grid: { color: colors.grid },
              },
              y: {
                title: {
                  display: true,
                  text: "Actual (h)",
                  color: colors.text,
                },
                ticks: { color: colors.text },
                grid: { color: colors.grid },
              },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function getChartColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
          text: styles.getPropertyValue("--chart-text") || "#333",
          grid: styles.getPropertyValue("--chart-grid") || "#e0e0e0",
          line: styles.getPropertyValue("--button-primary") || "#667eea",
          fill:
            (styles.getPropertyValue("--button-primary") || "#667eea") + "66",
        };
      }

      function renderCumulativeChart(timeEntries, memberStats) {
        // Sort entries by date
        const sortedEntries = [...timeEntries].sort((a, b) =>
          a.date.localeCompare(b.date),
        );

        if (sortedEntries.length === 0) {
          return;
        }

        // Get all unique dates in range
        const allDates = [...new Set(sortedEntries.map((e) => e.date))].sort();

        // Get all members
        const members = Object.keys(memberStats).sort();

        // Generate color palette
        const colors = [
          "#667eea",
          "#764ba2",
          "#f093fb",
          "#4facfe",
          "#43e97b",
          "#fa709a",
          "#fee140",
          "#30cfd0",
          "#a8edea",
          "#fed6e3",
          "#c471ed",
          "#f64f59",
        ];

        // Build cumulative data for each member
        const datasets = members.map((username, index) => {
          const memberData = {};
          let cumulative = 0;

          allDates.forEach((date) => {
            const dayEntries = sortedEntries.filter(
              (e) => e.username === username && e.date === date,
            );
            const dayHours = dayEntries.reduce((sum, e) => sum + e.hours, 0);
            cumulative += dayHours;
            memberData[date] = cumulative;
          });

          return {
            label: memberStats[username].name,
            data: allDates.map((date) => memberData[date] || 0),
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + "20",
            borderWidth: 3,
            fill: false,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: colors[index % colors.length],
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
            pointHoverRadius: 6,
          };
        });

        // Destroy existing chart
        if (allData.cumulativeChart) {
          allData.cumulativeChart.destroy();
        }

        // Create new chart
        const ctx = document.getElementById("cumulativeChart").getContext("2d");
        allData.cumulativeChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: allDates,
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  usePointStyle: true,
                  padding: 15,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return (
                      context.dataset.label +
                      ": " +
                      context.parsed.y.toFixed(1) +
                      "h"
                    );
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + "h";
                  },
                },
                title: {
                  display: true,
                  text: "Cumulative Hours",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Date",
                },
              },
            },
          },
        });
      }

      function renderPbiTable(timeEntries) {
        // Group by PBI
        const pbiData = {};
        timeEntries.forEach((entry) => {
          if (!pbiData[entry.issueId]) {
            pbiData[entry.issueId] = {
              id: entry.issueId,
              title: entry.issueTitle,
              hours: 0,
              contributors: new Set(),
            };
          }
          pbiData[entry.issueId].hours += entry.hours;
          pbiData[entry.issueId].contributors.add(entry.author);
        });

        const pbiArray = Object.values(pbiData);
        const maxHours = Math.max(...pbiArray.map((p) => p.hours), 0);

        const pbiTableBody = document.getElementById("pbiTableBody");

        if (pbiArray.length === 0) {
          pbiTableBody.innerHTML = "";
          document.getElementById("noPbiData").style.display = "block";
        } else {
          document.getElementById("noPbiData").style.display = "none";
          pbiTableBody.innerHTML = pbiArray
            .sort((a, b) => b.hours - a.hours)
            .map((pbi) => {
              const contributors = Array.from(pbi.contributors).join(", ");
              const percentage =
                maxHours > 0 ? (pbi.hours / maxHours) * 100 : 0;

              return `
                            <tr>
                                <td>#${pbi.id}</td>
                                <td>${pbi.title}</td>
                                <td>${contributors}</td>
                                <td class="hours">${pbi.hours.toFixed(1)}h</td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                    </div>
                                </td>
                            </tr>
                        `;
            })
            .join("");
        }
      }

      function renderMemberTable(memberArray, maxMemberHours) {
        const memberTableBody = document.getElementById("memberTableBody");

        if (memberArray.length === 0) {
          memberTableBody.innerHTML = "";
          document.getElementById("noMemberData").style.display = "block";
        } else {
          document.getElementById("noMemberData").style.display = "none";
          memberTableBody.innerHTML = memberArray
            .sort((a, b) => b.hours - a.hours)
            .map((member) => {
              const percentage =
                maxMemberHours > 0 ? (member.hours / maxMemberHours) * 100 : 0;

              return `
                            <tr class="member-row" onclick="showMemberDetails('${member.username}')">
                                <td>${member.name}</td>
                                <td>${member.pbiCount}</td>
                                <td class="hours">${member.hours.toFixed(1)}h</td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                    </div>
                                </td>
                            </tr>
                        `;
            })
            .join("");
        }
      }

      function showMemberDetails(username) {
        // Get filtered entries for this member
        const memberEntries = allData.filteredTimeEntries
          .filter((e) => e.username === username)
          .sort((a, b) => b.date.localeCompare(a.date));

        const member = memberEntries[0];
        if (!member) return;

        // Calculate total hours (including negative entries)
        const totalHours = memberEntries.reduce((sum, e) => sum + e.hours, 0);
        const entryCount = memberEntries.length;

        document.getElementById("modalTitle").textContent =
          `${member.author} - ${entryCount} ${entryCount === 1 ? "Entry" : "Entries"} (Total: ${totalHours.toFixed(1)}h)`;

        const modalBody = document.getElementById("modalBody");

        if (memberEntries.length === 0) {
          modalBody.innerHTML = `
                    <div class="empty-state">
                        <p>No time entries found for this date range</p>
                    </div>
                `;
        } else {
          modalBody.innerHTML = memberEntries
            .map((entry) => {
              // Display summary if present
              let comment = "";
              if (entry.summary && entry.summary.trim().length > 0) {
                // Escape HTML to prevent XSS
                const escapedSummary = entry.summary
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
                comment = `<div class="time-entry-comment">${escapedSummary}</div>`;
              }

              const isNegative = entry.hours < 0;
              const negativeClass = isNegative ? "negative" : "";
              const hoursDisplay = isNegative
                ? `${entry.hours.toFixed(1)}h`
                : `${entry.hours.toFixed(1)}h`;

              return `
                        <div class="time-entry ${negativeClass}">
                            <div class="time-entry-info">
                                <div class="time-entry-date">${entry.date}</div>
                                <div class="time-entry-pbi">#${entry.issueId}: ${entry.issueTitle}</div>
                                ${comment}
                            </div>
                            <div class="time-entry-hours ${negativeClass}">${hoursDisplay}</div>
                        </div>
                    `;
            })
            .join("");
        }

        const modal = document.getElementById("timeEntriesModal");
        modal.classList.add("active");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        const modal = document.getElementById("timeEntriesModal");
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden", "true");
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const timeEntriesModal = document.getElementById("timeEntriesModal");
        const projectBrowserModal = document.getElementById(
          "projectBrowserModal",
        );

        if (event.target === timeEntriesModal) {
          closeModal();
        }
        if (event.target === projectBrowserModal) {
          closeProjectBrowser();
        }
      };

      // Close modal on Escape key (handled in setupKeyboardShortcuts)

      // ========== DARK MODE FUNCTIONS ==========

      function initializeTheme() {
        const savedTheme = localStorage.getItem("dashboard-theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;

        const theme = savedTheme || (prefersDark ? "dark" : "light");
        document.documentElement.setAttribute(
          "data-theme",
          theme === "dark" ? "dark" : "",
        );

        // Update theme toggle button if it exists
        updateThemeToggleButton(theme);

        return theme;
      }

      function toggleDarkMode() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";

        document.documentElement.setAttribute(
          "data-theme",
          newTheme === "dark" ? "dark" : "",
        );
        localStorage.setItem("dashboard-theme", newTheme);

        // Update charts for new theme
        applyThemeToCharts();
        updateThemeToggleButton(newTheme);
      }

      function updateThemeToggleButton(theme) {
        const themeToggle = document.getElementById("themeToggleBtn");
        if (themeToggle) {
          themeToggle.textContent = theme === "dark" ? "Light" : "Dark";
          themeToggle.title =
            theme === "dark" ? "Switch to Light Mode" : "Switch to Dark Mode";
          themeToggle.setAttribute("aria-label", themeToggle.title);
        }
      }

      function applyThemeToCharts() {
        const isDark =
          document.documentElement.getAttribute("data-theme") === "dark";

        // Update cumulative chart if it exists
        if (allData.cumulativeChart) {
          const chartTextColor = isDark ? "#e0e0e0" : "#333333";
          const chartGridColor = isDark ? "#444444" : "#e0e0e0";

          allData.cumulativeChart.options.plugins.legend.labels.color =
            chartTextColor;
          allData.cumulativeChart.options.scales.x.ticks.color = chartTextColor;
          allData.cumulativeChart.options.scales.x.grid.color = chartGridColor;
          allData.cumulativeChart.options.scales.y.ticks.color = chartTextColor;
          allData.cumulativeChart.options.scales.y.grid.color = chartGridColor;
          allData.cumulativeChart.update("none");
        }
      }

      // Listen for system preference changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          if (!localStorage.getItem("dashboard-theme")) {
            // Only auto-switch if user hasn't set a preference
            const theme = e.matches ? "dark" : "light";
            document.documentElement.setAttribute(
              "data-theme",
              theme === "dark" ? "dark" : "",
            );
            applyThemeToCharts();
            updateThemeToggleButton(theme);
          }
        });

      // Initialize theme on page load
      initializeTheme();
    </script>
  </body>
</html>
