<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitLab Time Tracking Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load modular JavaScript files -->
    <script src="js/api-client.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/settings-manager.js" defer></script>
    <script src="js/theme-manager.js" defer></script>
    <script src="js/ui-manager.js" defer></script>
    <script src="js/chart-renderer.js" defer></script>
    <script src="js/table-renderer.js" defer></script>
    <script src="js/filter-manager.js" defer></script>
    <script src="js/project-browser.js" defer></script>
    <script src="js/main.js" defer></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
          "
        >
          <h1>GitLab Time Tracking Dashboard</h1>
          <button
            id="themeToggleBtn"
            onclick="toggleDarkMode()"
            style="
              padding: 8px 16px;
              font-size: 13px;
              background: var(--button-primary);
              color: var(--button-text);
              border: 2px solid transparent;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s ease;
            "
            title="Toggle Dark Mode"
            aria-label="Toggle dark mode"
          >
            Dark
          </button>
        </div>
        <div class="config-section">
          <div class="input-group">
            <label for="gitlabUrl">GitLab URL</label>
            <input
              type="text"
              id="gitlabUrl"
              placeholder="https://gitlab.com"
              value="https://gitlab.com"
            />
            <div class="help-text">Base URL for your GitLab instance.</div>
          </div>
          <div class="input-group">
            <label for="accessToken"
              >Access Token<span
                class="help-tooltip"
                title="Use a personal access token with read_api scope."
                >?</span
              ></label
            >
            <input
              type="password"
              id="accessToken"
              placeholder="Your GitLab access token"
            />
            <div class="help-text">Stored only in memory for this session.</div>
          </div>
          <div class="input-group">
            <label for="projectId"
              >Project ID<span
                class="help-tooltip"
                title="Find this in Project Settings → General or the project URL."
                >?</span
              ></label
            >
            <input type="text" id="projectId" placeholder="12345" />
            <div class="help-text">Numeric ID of the project to load.</div>
          </div>
          <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="showProjectBrowser()" aria-label="Browse projects">
              Browse Projects
            </button>
          </div>
          <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="fetchData()" aria-label="Load data">
              Load Data
            </button>
          </div>
          <div class="input-group">
            <label for="rememberSettings">Remember Settings</label>
            <div class="checkbox-row">
              <input type="checkbox" id="rememberSettings" checked />
              <span class="help-text"
                >Save GitLab URL and Project ID in this browser.</span
              >
            </div>
          </div>
        </div>

        <div class="help-text">
          Shortcuts: <strong>/</strong> focus project search,
          <strong>L</strong> load data, <strong>Esc</strong> close dialogs.
        </div>

        <div class="date-filter-section">
          <div class="input-group">
            <label for="filterType">Filter By</label>
            <select id="filterType" onchange="toggleFilterType()">
              <option value="date">Date Range</option>
              <option value="milestone">Milestone</option>
            </select>
          </div>
          <div id="dateRangeInputs" style="display: flex; gap: 15px; flex: 1">
            <div class="input-group">
              <label for="startDate">Start Date</label>
              <input type="date" id="startDate" />
            </div>
            <div class="input-group">
              <label for="endDate">End Date</label>
              <input type="date" id="endDate" />
            </div>
          </div>
          <div id="milestoneInput" style="display: none; flex: 1">
            <div class="input-group">
              <label for="milestoneSelect">Milestone</label>
              <select id="milestoneSelect">
                <option value="">Select a milestone...</option>
              </select>
            </div>
          </div>
          <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="applyFilter()" aria-label="Apply filter">
              Apply Filter
            </button>
          </div>
        </div>
      </div>

      <div
        id="error"
        style="display: none"
        class="error"
        role="alert"
        aria-live="polite"
      ></div>
      <div
        id="loading"
        style="display: none"
        class="loading"
        role="status"
        aria-live="polite"
      >
        <div class="spinner"></div>
        <p id="loadingMessage">Fetching data from GitLab...</p>
      </div>

      <div id="dashboard" style="display: none" class="dashboard">
        <!-- Tab Navigation -->
        <div
          style="
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
          "
          role="tablist"
          aria-label="Dashboard tabs"
        >
          <button
            class="tab-button active"
            data-tab="overview"
            onclick="switchTab('overview')"
            role="tab"
            aria-selected="true"
            aria-controls="tab-overview"
          >
            Overview
          </button>
          <button
            class="tab-button"
            data-tab="analytics"
            onclick="switchTab('analytics')"
            role="tab"
            aria-selected="false"
            aria-controls="tab-analytics"
          >
            Analytics
          </button>
          <button
            class="tab-button"
            data-tab="details"
            onclick="switchTab('details')"
            role="tab"
            aria-selected="false"
            aria-controls="tab-details"
          >
            Details
          </button>
        </div>

        <!-- Filter Status Bar -->
        <div
          id="filterStatus"
          style="
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            display: none;
          "
        ></div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content" style="display: block">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Hours Logged</div>
              <div class="stat-value" id="totalHours">0h</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Active PBIs</div>
              <div class="stat-value" id="totalPbis">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Team Members</div>
              <div class="stat-value" id="totalMembers">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Hours per Person</div>
              <div class="stat-value" id="avgHours">0h</div>
            </div>
          </div>

          <div class="chart-card">
            <h2>Cumulative Hours by Team Member</h2>
            <div class="chart-container">
              <canvas id="cumulativeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div id="tab-analytics" class="tab-content" style="display: none">
          <!-- Analytics Alerts -->
          <div id="analyticsAlerts"></div>

          <!-- Analytics Timestamp -->
          <div class="analytics-timestamp" id="analyticsTimestamp">
            Last updated: Never
          </div>

          <div class="analytics-grid">
            <div
              class="card analytics-card metric-clickable"
              onclick="showWorkloadDetails()"
            >
              <h2>
                <span>Workload Distribution</span>
                <div class="card-actions">
                  <button
                    class="icon-button"
                    onclick="
                      event.stopPropagation();
                      configureThresholds('workload');
                    "
                    title="Configure thresholds"
                    aria-label="Configure workload thresholds"
                  >
                    ⚙️
                  </button>
                </div>
              </h2>
              <div class="chart-container" style="height: 260px">
                <canvas id="workloadChart"></canvas>
              </div>
            </div>

            <div
              class="card analytics-card metric-clickable"
              onclick="showStalledDetails()"
            >
              <h2>
                <span>WIP Stalled Issues</span>
                <div class="card-actions">
                  <button
                    class="icon-button"
                    onclick="
                      event.stopPropagation();
                      configureThresholds('stalled');
                    "
                    title="Configure thresholds"
                    aria-label="Configure stalled issue thresholds"
                  >
                    ⚙️
                  </button>
                </div>
              </h2>
              <table>
                <thead>
                  <tr>
                    <th>Issue</th>
                    <th>Last Entry</th>
                    <th>Days Since</th>
                  </tr>
                </thead>
                <tbody id="stalledTableBody"></tbody>
              </table>
              <div id="stalledEmpty" class="no-data" style="display: none">
                No stalled issues detected.
              </div>
            </div>

            <div
              class="card analytics-card metric-clickable"
              onclick="showReworkDetails()"
            >
              <h2>
                <span>Rework Analysis</span>
                <div class="card-actions">
                  <button
                    class="icon-button"
                    onclick="
                      event.stopPropagation();
                      configureThresholds('rework');
                    "
                    title="Configure thresholds"
                    aria-label="Configure rework thresholds"
                  >
                    ⚙️
                  </button>
                </div>
              </h2>
              <table>
                <thead>
                  <tr>
                    <th>Issue</th>
                    <th>Negative Hours</th>
                    <th>Rework %</th>
                  </tr>
                </thead>
                <tbody id="reworkTableBody"></tbody>
              </table>
              <div id="reworkEmpty" class="no-data" style="display: none">
                No rework detected.
              </div>
            </div>

            <div
              class="card analytics-card metric-clickable"
              onclick="showAnomaliesDetails()"
            >
              <h2>
                <span>Anomalies</span>
                <div class="card-actions">
                  <button
                    class="icon-button"
                    onclick="
                      event.stopPropagation();
                      configureThresholds('anomalies');
                    "
                    title="Configure thresholds"
                    aria-label="Configure anomaly thresholds"
                  >
                    ⚙️
                  </button>
                </div>
              </h2>
              <div id="anomaliesSummary" class="help-text">
                No anomalies detected.
              </div>
              <div id="anomaliesList"></div>
            </div>

            <div
              class="card analytics-card metric-clickable"
              onclick="showBurnoutDetails()"
            >
              <h2>
                <span>Burnout Risk</span>
                <div class="card-actions">
                  <button
                    class="icon-button"
                    onclick="
                      event.stopPropagation();
                      configureThresholds('burnout');
                    "
                    title="Configure thresholds"
                    aria-label="Configure burnout thresholds"
                  >
                    ⚙️
                  </button>
                </div>
              </h2>
              <table>
                <thead>
                  <tr>
                    <th>Member</th>
                    <th>Rolling Avg (4w)</th>
                    <th>Risk</th>
                  </tr>
                </thead>
                <tbody id="burnoutTableBody"></tbody>
              </table>
              <div id="burnoutEmpty" class="no-data" style="display: none">
                No burnout risk detected.
              </div>
            </div>

            <div
              class="card analytics-card metric-clickable"
              onclick="showEstimationDetails()"
            >
              <h2>
                <span>Estimation Accuracy</span>
                <div class="card-actions">
                  <button
                    class="icon-button"
                    onclick="
                      event.stopPropagation();
                      configureThresholds('estimation');
                    "
                    title="Configure thresholds"
                    aria-label="Configure estimation thresholds"
                  >
                    ⚙️
                  </button>
                </div>
              </h2>
              <div class="chart-container" style="height: 260px">
                <canvas id="estimationChart"></canvas>
              </div>
              <div id="estimationSummary" class="help-text"></div>
            </div>
          </div>
        </div>

        <!-- Details Tab -->
        <div id="tab-details" class="tab-content" style="display: block">
          <div class="card">
            <h2>Hours by PBI</h2>
            <table id="pbiTable">
              <thead>
                <tr>
                  <th>PBI #</th>
                  <th>Title</th>
                  <th>Assignee</th>
                  <th>Hours Logged</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody id="pbiTableBody"></tbody>
            </table>
            <div id="noPbiData" class="no-data" style="display: none">
              No PBI data available. Make sure issues have time tracking
              entries.
            </div>
          </div>

          <div class="card">
            <h2>
              Hours by Team Member
              <small style="color: var(--text-muted); font-size: 14px"
                >(Click to view details)</small
              >
            </h2>
            <table id="memberTable">
              <thead>
                <tr>
                  <th>Team Member</th>
                  <th>PBIs Worked On</th>
                  <th>Total Hours</th>
                  <th>Progress</th>
                </tr>
              </thead>
              <tbody id="memberTableBody"></tbody>
            </table>
            <div id="noMemberData" class="no-data" style="display: none">
              No team member data available.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for time entries -->
    <div
      id="timeEntriesModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
      aria-hidden="true"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Time Entries</h2>
          <button
            class="modal-close"
            onclick="closeModal()"
            aria-label="Close time entries dialog"
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Time entries will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Modal for project browser -->
    <div
      id="projectBrowserModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="projectBrowserTitle"
      aria-hidden="true"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="projectBrowserTitle">Select Project</h2>
          <button
            class="modal-close"
            onclick="closeProjectBrowser()"
            aria-label="Close project browser"
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="projectBrowserBody">
          <div class="project-filters">
            <div class="filter-section">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 15px;
                "
              >
                <h3 style="margin: 0">Filter Options</h3>
                <div style="display: flex; gap: 10px">
                  <button
                    onclick="selectAllFilters()"
                    style="
                      padding: 6px 12px;
                      font-size: 12px;
                      background: #667eea;
                    "
                  >
                    Select All
                  </button>
                  <button
                    onclick="clearAllFilters()"
                    style="padding: 6px 12px; font-size: 12px; background: #999"
                  >
                    Clear All
                  </button>
                </div>
              </div>
              <div class="filter-checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" id="filterStarred" checked />
                  <span>Starred</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filterMember" checked />
                  <span>My Projects</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filterOwned" />
                  <span>Owned by Me</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filterInactive" />
                  <span>Archived</span>
                </label>
              </div>
            </div>
            <div class="filter-search">
              <input
                type="text"
                id="projectSearch"
                placeholder="Search by name or path..."
                onkeypress="if (event.key === 'Enter') searchProjects();"
              />
            </div>
            <button
              onclick="searchProjects()"
              class="search-button"
              aria-label="Search projects"
            >
              Search Projects
            </button>
          </div>
          <div class="loading" id="projectsLoading" style="display: none">
            <div class="spinner"></div>
            <p>Loading projects...</p>
          </div>
          <div
            id="projectsResultCount"
            style="margin-bottom: 10px; color: #666; font-size: 14px"
          ></div>
          <div id="projectsList" class="project-list"></div>
        </div>
      </div>
    </div>

    <div
      id="toastContainer"
      class="toast-container"
      aria-live="polite"
      aria-atomic="true"
    ></div>
  </body>
</html>
